{% extends "layouts/base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block content %}
<main class="container-fluid container-lg mt-3">
    <div class="d-flex gap-3 align-items-center">
        <h1>Edit Test: {{ test_form.instance.title }}</h1>
    </div>
    <div class="col-8 pb-5">
        <hr>
        <form class="mb-3" role="form" method="post" id="test-form" action="{% url 'edit_test' test_form.instance.id %}">
            {% csrf_token %}
            {% bootstrap_form test_form %}
            <div id="questions-container">
                {{ question_formset.management_form }}
                {% for form in question_formset %}
                    <div class="question-form border rounded p-3 mb-3" id="question-{{ form.prefix }}">
                        {% bootstrap_form form %}
                        <div id="answers-{{ form.prefix }}-container">
                            {% for qid, answer_formset in answer_formsets %}
                                {% if qid == form.instance.id %}
                                    {{ answer_formset.management_form }}
                                    {% for answer_form in answer_formset %}
                                        <div class="answer-form mb-3" id="answer-{{ answer_form.prefix }}">
                                            {% bootstrap_form answer_form %}
                                            <button type="button" class="btn btn-outline-danger remove-answer-btn" data-answer-id="{{ answer_form.prefix }}">Remove Answer</button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-outline-primary add-answer-btn" data-question-id="{{ form.prefix }}">Add Answer</button>
                        <button type="button" class="btn btn-danger remove-question-btn" data-question-id="{{ form.prefix }}">Remove Question</button>
                    </div>
                {% endfor %}
            </div>
            <button id="add-question-btn" class="btn btn-outline-primary" type="button">Add Question</button>
            <button class="btn btn-outline-success" type="submit">Save Changes</button>
        </form>
    </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('test-form');
        const addQuestionBtn = document.getElementById('add-question-btn');
        let questionIndex = {{ question_formset.total_form_count }};
        const questionsContainer = document.getElementById('questions-container');

        addQuestionBtn.addEventListener('click', function() {
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question-form', 'border', 'rounded', 'p-3', 'mb-3');
            questionDiv.id = `question-${questionIndex}`;
            questionDiv.innerHTML = `
                <div>
                    <label for="id_questions-${questionIndex}-question_text">Question ${questionIndex + 1}</label>
                    <textarea class="form-control" name="questions-${questionIndex}-question_text" id="id_questions-${questionIndex}-question_text" cols="40" rows="2" required></textarea>
                    <div class="mb-3">
                        <label for="id_questions-${questionIndex}-topic" class="form-label">Test Topic</label>
                        <input type="text" class="form-control" name="questions-${questionIndex}-topic" id="id_questions-${questionIndex}-topic" required>
                    </div>
                    <div>
                        <label for="id_questions-${questionIndex}-question_type">Question Type</label>
                        <select class="form-control" name="questions-${questionIndex}-question_type" id="id_questions-${questionIndex}-question_type" required>
                            <option value="text">Text</option>
                            <option value="single_choice">Single Choice</option>
                            <option value="multiple_choice">Multiple Choice</option>
                        </select>
                    </div>
                    <input type="hidden" name="questions-${questionIndex}-test" value="{{ test_form.instance.id }}">
                    <input type="hidden" name="questions-${questionIndex}-id" value="">
                </div>
                <div id="answers-${questionIndex}-container"></div>
                <button type="button" class="btn btn-outline-primary add-answer-btn" data-question-id="${questionIndex}">Add Answer</button>
                <button type="button" class="btn btn-outline-danger remove-question-btn" data-question-index="${questionIndex}">Remove Question</button>
            `;
            questionsContainer.appendChild(questionDiv);
            questionIndex++;
        });

        questionsContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-question-btn')) {
                const questionIndex = event.target.getAttribute('data-question-index');
                const questionDiv = document.getElementById(`question-${questionIndex}`);
                if (questionDiv) {
                    questionsContainer.removeChild(questionDiv);
                }
            } else if (event.target.classList.contains('add-answer-btn')) {
                const questionId = event.target.getAttribute('data-question-id');
                const answersContainer = document.getElementById(`answers-${questionId}-container`);
                const newAnswerIndex = answersContainer.children.length;
                const answerDiv = document.createElement('div');
                answerDiv.classList.add('answer-form', 'mb-3');
                answerDiv.innerHTML = `
                    <div class="form-group">
                        <label for="id_answers-${questionId}-${newAnswerIndex}-answer_text">Answer ${newAnswerIndex + 1}</label>
                        <input type="text" class="form-control" name="answers-${questionId}-${newAnswerIndex}-answer_text" id="id_answers-${questionId}-${newAnswerIndex}-answer_text" required>
                        <input type="hidden" name="answers-${questionId}-${newAnswerIndex}-question" value="${questionId}">
                        <input type="hidden" name="answers-${questionId}-${newAnswerIndex}-id" value="">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="answers-${questionId}-${newAnswerIndex}-is_correct" id="id_answers-${questionId}-${newAnswerIndex}-is_correct">
                            <label class="form-check-label" for="id_answers-${questionId}-${newAnswerIndex}-is_correct">Correct</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-danger remove-answer-btn" data-answer-id="new-answer-${newAnswerIndex}">Remove Answer</button>
                `;
                answersContainer.appendChild(answerDiv);
            } else if (event.target.classList.contains('remove-answer-btn')) {
                const answerDiv = event.target.closest('.answer-form');
                answerDiv.parentNode.removeChild(answerDiv);
            }
        });
    });
</script>
{% endblock %}
