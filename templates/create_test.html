{% extends "layouts/base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block content %}
<main class="container-fluid container-lg mt-3">
    <div class="d-flex gap-3 align-items-center">
        <h1>Создать тест</h1>
    </div>
    <div class="col-8 pb-5">
        <hr>
        <form class="mb-3" role="search" method="post" id="test-form" action="{% url 'create_test' %}">
            {% csrf_token %}
            {% bootstrap_form test_form %}
            <div id="questions-container"></div>

            <button id="add-question-btn" class="btn btn-outline-primary" type="button">Добавить вопрос</button>
            <button class="btn btn-outline-success" type="submit">Сохранить</button>
        </form>
    </div>
</main>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('test-form');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const questionsContainer = document.getElementById('questions-container');
        let questionIndex = 0;

        addQuestionBtn.addEventListener('click', function() {
            const questionDiv = document.createElement('div');
            questionDiv.id = `question-${questionIndex}`;
            questionDiv.innerHTML = `
                <div>
                    <label for="id_questions-${questionIndex}-question_text">Вопрос №${questionIndex + 1}</label>
                    <textarea class="form-control" name="questions-${questionIndex}-question_text" cols="40" rows="2" required></textarea>

                    <input type="hidden" name="questions-${questionIndex}-test" value="{{ test.id }}">
                    <input type="hidden" name="questions-${questionIndex}-id" value="">
                </div>
                <div>
                    <label for="id_questions-${questionIndex}-num_answers">Число ответов</label>
                    <input type="number" class="form-control" name="questions-${questionIndex}-num_answers" id="id_questions-${questionIndex}-num_answers" min="1" required>
                </div>
                <div>
                    <label for="id_questions-${questionIndex}-question_type">Тип вопроса</label>
                    <select class="form-control" name="questions-${questionIndex}-question_type" id="id_questions-${questionIndex}-question_type" required>
                        <option value="text">Текст</option>
                        <option value="single_choice">Один вариант</option>
                        <option value="multiple_choice">Несколько вариантов</option>
                    </select>
                </div>
                <div id="answers-${questionIndex}-container"></div>
                <button type="button" class="btn btn-outline-danger remove-question-btn m-3" data-question-index="${questionIndex}">Удалить вопрос</button>
            `;
            questionsContainer.appendChild(questionDiv);
            questionIndex++;
        });

        questionsContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-question-btn')) {
                const questionIndex = event.target.getAttribute('data-question-index');
                const questionDiv = document.getElementById(`question-${questionIndex}`);
                questionsContainer.removeChild(questionDiv);
            }
        });

        form.addEventListener('change', function(event) {
            const target = event.target;
            if (target.tagName === 'SELECT' && target.name.includes('question_type')) {
                const questionIndex = parseInt(target.name.match(/\d+/)[0]);
                const answersContainer = document.getElementById(`answers-${questionIndex}-container`);
                answersContainer.innerHTML = '';

                const numAnswersInput = document.getElementById(`id_questions-${questionIndex}-num_answers`);
                const numAnswers = parseInt(numAnswersInput.value);

                if (target.value === 'multiple_choice') {
                    for (let i = 0; i < numAnswers; i++) {
                        answersContainer.innerHTML += `
                            <div class="form-check m-3">
                                <input class="form-check-input" type="checkbox" name="questions-${questionIndex}-answers_${i}" id="id_questions-${questionIndex}-answers_${i}" >
                                <input type="text" class="form-control" name="questions-${questionIndex}-answer_${i}" id="id_questions-${questionIndex}-answer_${i}" placeholder="Answer ${i + 1}" required>
                            </div>
                        `;
                    }
                } else if (target.value === 'text') {
                    answersContainer.innerHTML += `
                        <div>
                            <input type="text" class="form-control m-3" name="questions-${questionIndex}-answer_${0}" id="id_questions-${questionIndex}-answer_${0}" placeholder="Answer " required>
                        </div>`;
                } else if (target.value === 'single_choice') {
                    for (let i = 0; i < numAnswers; i++) {
                        answersContainer.innerHTML += `
                            <div class="form-check m-3">
                                <input class="form-check-input" type="radio" name="questions-${questionIndex}-answers_${i}" id="id_questions-${questionIndex}-answers_${i}" >
                                <input type="text" class="form-control" name="questions-${questionIndex}-answer_${i}" id="id_questions-${questionIndex}-answer_${i}" placeholder="Answer ${i + 1}" required>
                            </div>
                        `;
                    }
                }
            }
        });
    });
</script>
{% endblock %}
